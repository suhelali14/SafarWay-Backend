# Schema Migration Notes

## Problems Identified

### 1. Missing Fields in Prisma Schema
The application code was referencing fields that might not be in the actual database yet:
- `validFrom` (DateTime)
- `validTill` (DateTime)

These fields were added to the schema but might require a migration to actually exist in the database.

### 2. Incorrect Use of createdAt Field
The code was trying to use `createdAt` as a relation field to connect to a user:
```javascript
createdAt: {
  connect: {
    id: req.user.id
  }
}
```

However, `createdAt` is a DateTime field that is auto-generated by Prisma, not a relation field.

## Immediate Solution

We've modified both frontend and backend code to fix these issues:

1. In the backend (`agency.controller.js`):
   - Removed the incorrect use of `createdAt` as a relation field
   - Removed the `validFrom` and `validTill` fields from database operations until migration is complete

2. In the frontend:
   - Added code to strip the validation fields before sending to the API

## Permanent Solution

To properly fix these issues, follow these steps:

### For the validFrom/validTill fields:

1. Verify the fields are in the Prisma schema:
   ```prisma
   model TourPackage {
     // ... existing fields
     validFrom         DateTime?  // Date when package becomes valid
     validTill         DateTime?  // Date when package expires
     // ... other fields
   }
   ```

2. Create and run a migration:
   ```bash
   npx prisma migrate dev --name add_valid_date_fields
   ```

### For the createdBy relationship:

1. If you need to track who created each package, add a proper relation to the schema:
   ```prisma
   model TourPackage {
     // ... existing fields
     createdById      String?
     createdBy        User?     @relation(name: "PackageCreator", fields: [createdById], references: [id])
     // ... other fields
   }
   
   model User {
     // ... existing fields
     createdPackages   TourPackage[] @relation("PackageCreator")
     // ... other fields
   }
   ```

2. Create and run a migration:
   ```bash
   npx prisma migrate dev --name add_created_by_relation
   ```

3. Update the controller to use this relation correctly:
   ```javascript
   // In createPackage function
   createdById: req.user.id,
   ```

4. Restart the server to apply the changes

## Affected Files

- `prisma/schema.prisma`
- `src/controllers/agency.controller.js`
- `src/pages/agency/packages/PackageForm.tsx`
- `src/pages/agency/packages/new.tsx` 