// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SAFARWAY_ADMIN
  SAFARWAY_USER
  AGENCY_ADMIN
  AGENCY_USER
  CUSTOMER
}

enum UserStatus {
  INVITED
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum TourType {
  ADVENTURE
  CULTURAL
  WILDLIFE
  BEACH
  MOUNTAIN
  CITY
  CRUISE
  OTHER
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  PENDING_APPROVAL
  PENDING_PAYMENT
  RESERVED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  REFUNDED
  PARTIALLY_REFUNDED
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  ASSIGNED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
}

enum PaymentMode {
  PARTIAL
  FULL
}

enum PaymentType {
  PARTIAL
  FULL
}

enum PostType {
  PHOTO
  REEL
  CAROUSEL
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
  HIDDEN
  REPORTED
}

enum CommentStatus {
  ACTIVE
  HIDDEN
  REPORTED
  DELETED
}

enum ReportReason {
  SPAM
  INAPPROPRIATE_CONTENT
  HARASSMENT
  COPYRIGHT
  FAKE_REVIEW
  OTHER
}

model User {
  id              String     @id @default(uuid())
  name            String?
  email           String     @unique
  password        String?
  phone           String?
  role            Role
  status          UserStatus @default(INVITED)
  profileImage    String?
  provider        String?    @default("EMAIL")
  deviceTokens    String[]
  agencyId        String?
  agency          Agency?    @relation(fields: [agencyId], references: [id])
  customer        Customer?
  inviteToken     String?    @unique
  invitedByUserId String?
  invitedBy       User?      @relation("UserInvites", fields: [invitedByUserId], references: [id])
  invitedUsers    User[]     @relation("UserInvites")
  invitedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

    // Relations
  bookings             Booking[]
  refundRequests       RefundRequest[]
  supportTickets       SupportTicket[]
  ticketResponses      TicketResponse[]
  ticketAssignmentLogs TicketAssignmentLog[]
  sessions             Session[]
  wishlist             Wishlist[]
  reviews              Review[]
  mediaLikes           MediaLike[]
  subscriptions        Subscription[]
  
  // Post System Relations
  posts                Post[]
  postLikes            PostLike[]
  postComments         PostComment[]
  postCommentLikes     PostCommentLike[]
  postSaves            PostSave[]
  postShares           PostShare[]
  postReports          PostReport[]
  postCommentReports   PostCommentReport[]
  postTags             PostTag[]
  postViews            PostView[]
  postCollections      PostCollection[]
}

model Session {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
}

model Agency {
  id           String   @id @default(uuid())
  name         String
  description  String?
  address      String?
  contactEmail String
  contactPhone String
  logo         String?
  mediaUrls    String[] // Array of media URLs
  coverImage   String?

  verifiedByAdminId String? // ID of the admin who verified
  verifiedAt        DateTime?
  status            String    @default("PENDING") // PENDING, ACTIVE, INACTIVE, REJECTED

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  verificationDocuments VerificationDocument[]
  settings              AgencySettings?

  users         User[]
  tourPackages  TourPackage[]
  bookings      Booking[]
  reviews       Review[]
  mediaItems    AgencyMedia[]
  subscriptions Subscription[]
  posts         Post[] // Agency posts/content
}

model Customer {
  id        String   @id @default(uuid())
  userId    String   @unique
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User      @relation(fields: [userId], references: [id])
  bookings Booking[]
}

model TourPackage {
  id                String    @id @default(uuid())
  title             String
  subtitle          String?
  summary           String?   @db.Text
  duration          Int // in days
  maxGroupSize      Int
  pricePerPerson    Float
  price             Float? // For compatibility with existing code
  discountPrice     Float?
  priceType         String? // PER_PERSON, TOTAL
  tourType          TourType
  description       String    @db.Text
  highlights        String[] // Array of highlights
  includedItems     String[] // Array of included items
  excludedItems     String[] // Array of excluded items
  minimumAge        Int?
  maximumPeople     Int?
  isFlexible        Boolean?  @default(false)
  difficultyLevel   String?
  startDate         DateTime?
  endDate           DateTime?
  validFrom         DateTime? // Added for date validation period
  validTill         DateTime? // Added for date validation period
  coverImage        String?
  galleryImages     String[] // Array of image URLs
  phoneNumber       String?
  email             String?
  whatsapp          String?
  cancelationPolicy String?   @db.Text
  additionalInfo    String?   @db.Text
  status            String    @default("ACTIVE") // ACTIVE, INACTIVE, CANCELLED
  destination       String? // Added for backward compatibility with existing API
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relations
  agencyId     String
  agency       Agency        @relation(fields: [agencyId], references: [id])
  itinerary    Itinerary[]
  bookings     Booking[]
  wishlist     Wishlist[]
  offers       Offer[]
  destinations Destination[]
  inclusions   Inclusion[]
  exclusions   Exclusion[]
  posts        Post[]        // Posts about this tour package

  // Indexes for optimized queries
  @@index([status])
  @@index([tourType])
  @@index([pricePerPerson])
  @@index([agencyId])
  @@index([createdAt])
  @@index([destination])
}

model Itinerary {
  id            String   @id @default(uuid())
  day           Int
  title         String
  description   String   @db.Text
  activities    Json // Array of activities with time slots
  meals         Json // Object with breakfast, lunch, dinner booleans
  accommodation Json // Object with accommodation details
  transport     Json // Object with transport details
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  tourPackageId String
  tourPackage   TourPackage @relation(fields: [tourPackageId], references: [id])
}

model BookingPerson {
  id           String           @id @default(uuid())
  fullName     String
  dateOfBirth  DateTime
  email        String?
  phoneNumber  String?

  booking      Booking          @relation(fields: [bookingId], references: [id])
  bookingId    String

  documents    PersonDocument[] // ðŸ‘ˆ one-to-many relation
}

model PersonDocument {
  id              String   @id @default(uuid())
  documentType    String   // e.g., "Passport", "Aadhaar", "Visa", etc.
  documentNumber  String
  fileUrl         String?  // Optional if you're uploading scanned copy or image

  person          BookingPerson  @relation(fields: [personId], references: [id])
  personId        String
}

model Payment {
  id            String   @id @default(uuid())
  amount        Float
  status        PaymentStatus   // SUCCESS / FAILED / PENDING
  paymentType   PaymentType     // PARTIAL / FULL
  createdAt     DateTime @default(now())

  booking       Booking  @relation(fields: [bookingId], references: [id])
  bookingId     String
}

model Booking {
  id                 String        @id @default(uuid())
  startDate          DateTime
  endDate            DateTime? // Added endDate field
  numberOfPeople     Int
  totalPrice         Float
  platformFee        Float
  agencyPayoutAmount Float
  status             BookingStatus @default(PENDING)
  paymentStatus      PaymentStatus @default(PENDING)
  paymentmMethod     String
  cashfreeOrderId    String
  transactionId      String
  payoutStatus       String
  refundRequested    Boolean       @default(false)
  refundStatus       RefundStatus?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  paymentMode         PaymentMode
  agencyApproval      Boolean         @default(false)
  partialAmountPaid   Boolean         @default(false)

  // Relations
  agencyId      String
  userId        String
  user          User           @relation(fields: [userId], references: [id])
  customerId    String
  customer      Customer       @relation(fields: [customerId], references: [id])
  tourPackageId String
  tourPackage   TourPackage    @relation(fields: [tourPackageId], references: [id])
  agency        Agency         @relation(fields: [agencyId], references: [id])
  refundRequest RefundRequest?
  Review        Review?
  travelers           BookingPerson[] // List of persons (adults, kids, etc.)
  payments            Payment[]       // Payment history
  posts               Post[]          // Posts related to this booking

  notes               String?         // Optional for admin/agency use
}

model RefundRequest {
  id        String       @id @default(uuid())
  bookingId String       @unique
  booking   Booking      @relation(fields: [bookingId], references: [id])
  userId    String
  user      User         @relation(fields: [userId], references: [id])
  amount    Float
  reason    String       @db.Text
  status    RefundStatus @default(PENDING)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model SupportTicket {
  id             String                @id @default(uuid())
  userId         String
  user           User                  @relation(fields: [userId], references: [id])
  subject        String
  message        String                @db.Text
  status         TicketStatus          @default(OPEN)
  priority       TicketPriority        @default(MEDIUM)
  responses      TicketResponse[]
  assignmentLogs TicketAssignmentLog[]
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
}

model TicketResponse {
  id        String        @id @default(uuid())
  ticketId  String
  ticket    SupportTicket @relation(fields: [ticketId], references: [id])
  userId    String
  user      User          @relation(fields: [userId], references: [id])
  message   String        @db.Text
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model TicketAssignmentLog {
  id             String        @id @default(uuid())
  ticketId       String
  ticket         SupportTicket @relation(fields: [ticketId], references: [id])
  userId         String
  user           User          @relation(fields: [userId], references: [id])
  previousStatus TicketStatus?
  newStatus      TicketStatus?
  message        String?       @db.Text
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
}

model Wishlist {
  id            String      @id @default(uuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id])
  tourPackageId String
  tourPackage   TourPackage @relation(fields: [tourPackageId], references: [id])
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@unique([userId, tourPackageId])
}

model Offer {
  id            String       @id @default(uuid())
  title         String
  description   String       @db.Text
  discountType  String // PERCENTAGE, FIXED
  discountValue Float
  startDate     DateTime
  endDate       DateTime
  code          String?      @unique
  tourPackageId String?
  tourPackage   TourPackage? @relation(fields: [tourPackageId], references: [id])
  status        String       @default("ACTIVE") // ACTIVE, INACTIVE
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
}

model VerificationDocument {
  id           String   @id @default(uuid())
  name         String
  documentType String
  documentUrl  String
  status       String   @default("pending") // pending, approved, rejected
  uploadedAt   DateTime

  agency   Agency @relation(fields: [agencyId], references: [id])
  agencyId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AgencySettings {
  id              String  @id @default(uuid())
  notifyBookings  Boolean @default(true)
  notifyMessages  Boolean @default(true)
  notifyMarketing Boolean @default(false)
  isPublic        Boolean @default(true)

  agency   Agency @relation(fields: [agencyId], references: [id])
  agencyId String @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Destination {
  id          String  @id @default(uuid())
  name        String
  description String? @db.Text
  image       String?

  tourPackages TourPackage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Inclusion {
  id          String  @id @default(uuid())
  name        String
  description String? @db.Text
  icon        String?

  tourPackages TourPackage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Exclusion {
  id          String  @id @default(uuid())
  name        String
  description String? @db.Text
  icon        String?

  tourPackages TourPackage[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Review {
  id                String    @id @default(uuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id])
  agencyId          String
  agency            Agency    @relation(fields: [agencyId], references: [id])
  bookingId         String?   @unique
  booking           Booking?  @relation(fields: [bookingId], references: [id])
  rating            Int
  comment           String    @db.Text
  isVerifiedBooking Boolean   @default(false)
  responseText      String?   @db.Text
  responseDate      DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([agencyId])
  @@index([userId])
}

model AgencyMedia {
  id          String      @id @default(uuid())
  agencyId    String
  agency      Agency      @relation(fields: [agencyId], references: [id])
  type        String // IMAGE, VIDEO, ANNOUNCEMENT
  url         String
  caption     String?     @db.Text
  likes       Int         @default(0)
  publishedAt DateTime    @default(now())
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  mediaLikes  MediaLike[]

  @@index([agencyId])
}

model MediaLike {
  id        String      @id @default(uuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id])
  mediaId   String
  media     AgencyMedia @relation(fields: [mediaId], references: [id])
  likedAt   DateTime    @default(now())
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([userId, mediaId])
}

model Subscription {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id])
  agencyId     String
  agency       Agency   @relation(fields: [agencyId], references: [id])
  subscribedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([userId, agencyId])
}

// ============ POST SYSTEM MODELS ============

model Post {
  id              String     @id @default(uuid())
  type            PostType   @default(PHOTO)
  caption         String?    @db.Text
  mediaUrls       String[]   // Array of image/video URLs
  thumbnailUrl    String?    // Thumbnail for reels
  duration        Int?       // Duration in seconds for reels
  location        String?
  status          PostStatus @default(PUBLISHED)
  isVerified      Boolean    @default(false) // Verified travel post
  viewCount       Int        @default(0)
  shareCount      Int        @default(0)
  
  // Business Logic Fields
  isEligible      Boolean    @default(false) // Can user post about this trip
  tripCompleted   Boolean    @default(false) // Has the trip been completed
  
  // Relations
  userId          String
  user            User       @relation(fields: [userId], references: [id])
  agencyId        String
  agency          Agency     @relation(fields: [agencyId], references: [id])
  tourPackageId   String
  tourPackage     TourPackage @relation(fields: [tourPackageId], references: [id])
  bookingId       String
  booking         Booking    @relation(fields: [bookingId], references: [id])
  
  // Post Interactions
  likes           PostLike[]
  comments        PostComment[]
  saves           PostSave[]
  shares          PostShare[]
  reports         PostReport[]
  tags            PostTag[]
  hashtags        PostHashtag[]
  views           PostView[]
  collectionItems PostCollectionItem[]
  
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  @@index([userId])
  @@index([agencyId])
  @@index([tourPackageId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([isVerified])
}

model PostLike {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([postId])
}

model PostComment {
  id              String        @id @default(uuid())
  content         String        @db.Text
  status          CommentStatus @default(ACTIVE)
  likesCount      Int           @default(0)
  
  // Relations
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  postId          String
  post            Post          @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  // Nested Comments (Replies)
  parentCommentId String?
  parentComment   PostComment?  @relation("CommentReplies", fields: [parentCommentId], references: [id])
  replies         PostComment[] @relation("CommentReplies")
  
  // Comment Interactions
  likes           PostCommentLike[]
  reports         PostCommentReport[]
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([postId])
  @@index([userId])
  @@index([parentCommentId])
  @@index([status])
}

model PostCommentLike {
  id        String      @id @default(uuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id])
  commentId String
  comment   PostComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())

  @@unique([userId, commentId])
  @@index([commentId])
}

model PostSave {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, postId])
  @@index([userId])
  @@index([postId])
}

model PostShare {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  platform  String?  // whatsapp, facebook, instagram, etc.
  createdAt DateTime @default(now())

  @@index([postId])
  @@index([userId])
}

model PostReport {
  id          String       @id @default(uuid())
  reason      ReportReason
  description String?      @db.Text
  status      String       @default("PENDING") // PENDING, REVIEWED, RESOLVED
  
  // Relations
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  postId      String
  post        Post         @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([postId])
  @@index([status])
}

model PostCommentReport {
  id          String       @id @default(uuid())
  reason      ReportReason
  description String?      @db.Text
  status      String       @default("PENDING") // PENDING, REVIEWED, RESOLVED
  
  // Relations
  userId      String
  user        User         @relation(fields: [userId], references: [id])
  commentId   String
  comment     PostComment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([commentId])
  @@index([status])
}

model PostTag {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String   // Tagged user
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@index([postId])
  @@index([userId])
}

model PostHashtag {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  hashtag   String   // e.g., "#kerala", "#adventure"
  createdAt DateTime @default(now())

  @@index([postId])
  @@index([hashtag])
}

model PostView {
  id        String   @id @default(uuid())
  userId    String?  // Null for anonymous views
  user      User?    @relation(fields: [userId], references: [id])
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([postId])
  @@index([userId])
  @@index([createdAt])
}

// Collection/Album feature
model PostCollection {
  id          String              @id @default(uuid())
  name        String
  description String?             @db.Text
  coverImage  String?
  isPublic    Boolean             @default(true)
  
  // Relations
  userId      String
  user        User                @relation(fields: [userId], references: [id])
  posts       PostCollectionItem[]
  
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  @@index([userId])
  @@index([isPublic])
}

model PostCollectionItem {
  id           String         @id @default(uuid())
  collectionId String
  collection   PostCollection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  postId       String
  post         Post           @relation(fields: [postId], references: [id], onDelete: Cascade)
  order        Int            @default(0)
  createdAt    DateTime       @default(now())

  @@unique([collectionId, postId])
  @@index([collectionId])
  @@index([postId])
}
